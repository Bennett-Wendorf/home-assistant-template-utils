{#
  Natural Language Dates and Times Templates
  
  A collection of Jinja macros for outputting natural language dates and times in Home Assistant templates.
  
  Author: Bennett Wendorf
  License: MIT
#}

{%- macro macro_get_weekday_index(weekday_string, returns) -%}
  {%- set weekday_index_map = {'monday': 1, 'tuesday': 2, 'wednesday': 3, 'thursday': 4, 'friday': 5, 'saturday': 6, 'sunday': 7} -%}
  {%- set lowercase_weekday_string = weekday_string | lower -%}
  {%- do returns(weekday_index_map[lowercase_weekday_string]) -%}
{%- endmacro -%}
{%- set get_weekday_index = macro_get_weekday_index | as_function -%}

{# Convert a datetime to a relative date string (i.e. Today, tomorrow, Friday, Thursday, May 28th, 2026, etc.) #}
{%- macro relative_date(dt) %}
  {%- set target  = as_datetime(dt) %}
  {%- set today   = now().date() %}
  {%- set diff    = (target.date() - today).days %}   {# days difference (can be negative)#}
  {%- if diff == 0 %}
    Today

  {%- elif diff == 1 %}
    Tomorrow

  {%- elif 0 < diff <= 6 %}
    {{ target.strftime('%A') }}     {# e.g. Friday #}

  {%- elif diff > 6 %}
    {%- set day   = target.strftime('%d') | int %}
    {%- set suffix = "th" %}
    {%- if day % 10 == 1 and day != 11 %}
      {%- set suffix = "st" %}
    {%- elif day % 10 == 2 and day != 12 %}
      {%- set suffix = "nd" %}
    {%- elif day % 10 == 3 and day != 13 %}
      {%- set suffix = "rd" %}
    {%- endif %}
    {{ target.strftime('%a, %b ') }}{{ day }}{{ suffix }}, {{ target.strftime('%Y') }}

  {%- else %}
    In the past    {# optional handling for dates before today #}
  {%- endif %}
{%- endmacro %}

{%- macro _macro_next_weekday_from_date(weekday, datetime, offset) %}
  {%- set wd = (weekday - 1) % 7 %}
  {{- datetime + timedelta(days=(wd - datetime.weekday()) + offset) }}
{%- endmacro %}

{%- macro macro_this_weekday_from_date(weekday, datetime) %}
  {{- _macro_next_weekday_from_date(weekday, datetime, 0) }}
{%- endmacro %}

{%- macro macro_nearest_day_from_date(weekday, datetime) %}
  {%- set today_timestamp = as_timestamp(today_at())|int %}
  {%- set datetime_timestamp = as_timestamp(datetime)|int %}
  {%- set this_weekday_timestamp = as_timestamp(macro_this_weekday_from_date(weekday, datetime))|int %}
  {%- if datetime_timestamp <  this_weekday_timestamp %}
    {{- _macro_next_weekday_from_date(weekday, datetime, 0) }}
  {%- else %}
    {{- _macro_next_weekday_from_date(weekday, datetime, 7) }}
  {%- endif %}
{%- endmacro %}

{# This is the same as macro_nearest_day_from_date except that if datetime is already that day, then datetime will be returned instead of the next week #}
{%- macro macro_nearest_day_from_date_inclusive(weekday, datetime) -%}
  {%- if weekday == datetime.isoweekday() -%}
    {{ datetime }}
  {%- else -%}
    {{ macro_nearest_day_from_date(weekday, datetime) }}
  {%- endif -%}
{%- endmacro -%}

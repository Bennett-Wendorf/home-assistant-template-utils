{#
  Natural Language Parsing Templates
  
  A collection of Jinja macros for parsing natural language numbers, dates, and times
  in Home Assistant templates.
  
  Author: Bennett Wendorf
  License: MIT
#}

{# ==================== NUMBER PARSING ==================== #}

{#
  Parse text numbers to integers
  Examples: "one" -> 1, "twenty-five" -> 25, "one hundred" -> 100
#}
{% macro text_to_number(text) %}
  {% set text = text | lower | trim %}
  {% set ones = {
    "zero": 0, "one": 1, "two": 2, "three": 3, "four": 4,
    "five": 5, "six": 6, "seven": 7, "eight": 8, "nine": 9,
    "ten": 10, "eleven": 11, "twelve": 12, "thirteen": 13,
    "fourteen": 14, "fifteen": 15, "sixteen": 16, "seventeen": 17,
    "eighteen": 18, "nineteen": 19
  } %}
  {% set tens = {
    "twenty": 20, "thirty": 30, "forty": 40, "fifty": 50,
    "sixty": 60, "seventy": 70, "eighty": 80, "ninety": 90
  } %}
  {% set scales = {
    "hundred": 100, "thousand": 1000, "million": 1000000
  } %}
  
  {# Direct match in ones #}
  {% if text in ones %}
    {{ ones[text] }}
  {# Direct match in tens #}
  {% elif text in tens %}
    {{ tens[text] }}
  {# Handle compound numbers like "twenty-five" #}
  {% elif "-" in text %}
    {% set parts = text.split("-") %}
    {% if parts[0] in tens and parts[1] in ones %}
      {{ tens[parts[0]] + ones[parts[1]] }}
    {% else %}
      {{ text }}
    {% endif %}
  {# Handle "hundred", "thousand", etc. #}
  {% elif " " in text %}
    {% set words = text.split() %}
    {% set result = 0 %}
    {% set current = 0 %}
    {% for word in words %}
      {% if word in ones %}
        {% set current = current + ones[word] %}
      {% elif word in tens %}
        {% set current = current + tens[word] %}
      {% elif word in scales %}
        {% if current == 0 %}
          {% set current = 1 %}
        {% endif %}
        {% set current = current * scales[word] %}
        {% if scales[word] >= 100 %}
          {% set result = result + current %}
          {% set current = 0 %}
        {% endif %}
      {% endif %}
    {% endfor %}
    {{ result + current }}
  {% else %}
    {{ text }}
  {% endif %}
{% endmacro %}

{# ==================== TIME PARSING ==================== #}

{#
  Parse relative time expressions to minutes
  Examples: "in 5 minutes" -> 5, "in an hour" -> 60, "in 2 hours" -> 120
#}
{% macro relative_time_to_minutes(text) %}
  {% set text = text | lower | trim %}
  {% set result = 0 %}
  
  {# Handle "in X minutes/hours" #}
  {% if "minute" in text %}
    {% if "a minute" in text or "1 minute" in text or "one minute" in text %}
      {% set result = 1 %}
    {% else %}
      {% set num_match = text | regex_findall_index('(\\d+)\\s*minute') %}
      {% if num_match %}
        {% set result = num_match | int %}
      {% endif %}
    {% endif %}
  {% elif "hour" in text %}
    {% if "an hour" in text or "1 hour" in text or "one hour" in text %}
      {% set result = 60 %}
    {% else %}
      {% set num_match = text | regex_findall_index('(\\d+)\\s*hour') %}
      {% if num_match %}
        {% set result = (num_match | int) * 60 %}
      {% endif %}
    {% endif %}
  {% elif "second" in text %}
    {% set num_match = text | regex_findall_index('(\\d+)\\s*second') %}
    {% if num_match %}
      {% set result = ((num_match | int) / 60) | round(2) %}
    {% endif %}
  {% endif %}
  
  {{ result }}
{% endmacro %}

{#
  Parse time of day expressions
  Examples: "noon" -> "12:00", "midnight" -> "00:00", "3pm" -> "15:00"
#}
{% macro parse_time_of_day(text) %}
  {% set text = text | lower | trim %}
  
  {% if text == "noon" or text == "midday" %}
    12:00
  {% elif text == "midnight" %}
    00:00
  {% elif "pm" in text or "am" in text %}
    {% set num_match = text | regex_findall_index('(\\d+)') %}
    {% if num_match %}
      {% set hour = num_match | int %}
      {% if "pm" in text and hour != 12 %}
        {% set hour = hour + 12 %}
      {% elif "am" in text and hour == 12 %}
        {% set hour = 0 %}
      {% endif %}
      {{ "%02d:00" | format(hour) }}
    {% else %}
      {{ text }}
    {% endif %}
  {% else %}
    {{ text }}
  {% endif %}
{% endmacro %}

{# ==================== DATE PARSING ==================== #}

{#
  Parse relative date expressions
  Examples: "today" -> today's date, "tomorrow" -> tomorrow's date, "yesterday" -> yesterday's date
#}
{% macro parse_relative_date(text) %}
  {% set text = text | lower | trim %}
  
  {% if text == "today" %}
    {{ now().date() }}
  {% elif text == "tomorrow" %}
    {{ (now() + timedelta(days=1)).date() }}
  {% elif text == "yesterday" %}
    {{ (now() - timedelta(days=1)).date() }}
  {% elif "in" in text and "day" in text %}
    {% set num_match = text | regex_findall_index('(\\d+)\\s*day') %}
    {% if num_match %}
      {{ (now() + timedelta(days=num_match | int)).date() }}
    {% endif %}
  {% elif "ago" in text and "day" in text %}
    {% set num_match = text | regex_findall_index('(\\d+)\\s*day') %}
    {% if num_match %}
      {{ (now() - timedelta(days=num_match | int)).date() }}
    {% endif %}
  {% else %}
    {{ text }}
  {% endif %}
{% endmacro %}

{#
  Parse day of week expressions
  Examples: "monday" -> next Monday's date, "next friday" -> next Friday's date
#}
{% macro parse_day_of_week(text) %}
  {% set text = text | lower | trim %}
  {% set days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"] %}
  {% set current_day = now().weekday() %}
  
  {% for idx, day in days %}
    {% if day in text %}
      {% set target_day = idx %}
      {% set days_ahead = target_day - current_day %}
      {% if days_ahead <= 0 %}
        {% set days_ahead = days_ahead + 7 %}
      {% endif %}
      {{ (now() + timedelta(days=days_ahead)).date() }}
    {% endif %}
  {% endfor %}
{% endmacro %}

{# ==================== DURATION PARSING ==================== #}

{#
  Parse duration expressions to seconds
  Examples: "30 seconds" -> 30, "5 minutes" -> 300, "2 hours" -> 7200
#}
{% macro duration_to_seconds(text) %}
  {% set text = text | lower | trim %}
  {% set total_seconds = 0 %}
  
  {# Parse hours #}
  {% if "hour" in text %}
    {% set num_match = text | regex_findall_index('(\\d+)\\s*hour') %}
    {% if num_match %}
      {% set total_seconds = total_seconds + ((num_match | int) * 3600) %}
    {% elif "an hour" in text or "one hour" in text %}
      {% set total_seconds = total_seconds + 3600 %}
    {% endif %}
  {% endif %}
  
  {# Parse minutes #}
  {% if "minute" in text %}
    {% set num_match = text | regex_findall_index('(\\d+)\\s*minute') %}
    {% if num_match %}
      {% set total_seconds = total_seconds + ((num_match | int) * 60) %}
    {% elif "a minute" in text or "one minute" in text %}
      {% set total_seconds = total_seconds + 60 %}
    {% endif %}
  {% endif %}
  
  {# Parse seconds #}
  {% if "second" in text %}
    {% set num_match = text | regex_findall_index('(\\d+)\\s*second') %}
    {% if num_match %}
      {% set total_seconds = total_seconds + (num_match | int) %}
    {% endif %}
  {% endif %}
  
  {{ total_seconds }}
{% endmacro %}

{# ==================== HELPER MACROS ==================== #}

{#
  Check if text contains a time expression
#}
{% macro is_time_expression(text) %}
  {% set text = text | lower %}
  {% set time_keywords = ["minute", "hour", "second", "am", "pm", "noon", "midnight", "morning", "afternoon", "evening", "night"] %}
  {% set is_time = namespace(value=false) %}
  {% for keyword in time_keywords %}
    {% if keyword in text %}
      {% set is_time.value = true %}
    {% endif %}
  {% endfor %}
  {{ is_time.value }}
{% endmacro %}

{#
  Check if text contains a date expression
#}
{% macro is_date_expression(text) %}
  {% set text = text | lower %}
  {% set date_keywords = ["today", "tomorrow", "yesterday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday", "day", "week", "month", "year"] %}
  {% set is_date = namespace(value=false) %}
  {% for keyword in date_keywords %}
    {% if keyword in text %}
      {% set is_date.value = true %}
    {% endif %}
  {% endfor %}
  {{ is_date.value }}
{% endmacro %}
